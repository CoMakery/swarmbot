#!/usr/bin/env coffee
#
# Usage: deploy herokuEnv herokuApp
#

require 'shelljs/global'
{ json, log, p, pjson, run } = require 'lightsaber'

[herokuApp] = process.argv[-1...]

herokuRemote = "git@heroku.com:#{herokuApp}.git"
run "git fetch --unshallow", relaxed: true       # Circle CI fetches git shallowly, which can cause failures pushing to heroku
deployResult = run("git push --force #{herokuRemote} HEAD:refs/heads/master", relaxed: true).code
if deployResult is 0
  ref = process.env.CIRCLE_SHA1 or exec('git rev-parse head').output.trim()
  run "heroku config:set GIT_REF=#{ref} --app #{herokuApp}"
exit deployResult
