#!/usr/bin/env coffee

{ json, log, p, pjson, run } = require 'lightsaber'
{ compact, last } = require 'lodash'

{argv} = process

if argv.length isnt 3
  console.error """Usage: deploy herokuApp1[,herokuApp2][,herokuAppN]
    Got: #{json argv}"""
  process.exit 1

herokuAppList = last argv
herokuApps = compact herokuAppList.split /[,\s]+/
deployResults = 0

for herokuApp in herokuApps
  log """

    ************************************************************************
    Deploying to #{herokuApp}
    ************************************************************************
  """
  herokuRemote = "git@heroku.com:#{herokuApp}.git"
  run "git fetch --unshallow", relaxed: true  # Circle CI fetches git shallowly, which can cause failures pushing to heroku
  deployResult = run("git push --force #{herokuRemote} HEAD:refs/heads/master", relaxed: true).code
  if deployResult is 0
    ref = process.env.CIRCLE_SHA1 or run('git rev-parse head').output.trim()
    run "heroku config:set GIT_REF=#{ref} --app #{herokuApp}"
  deployResults += deployResult

process.exit deployResult
